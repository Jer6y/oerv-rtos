# UniProton QA

此文档用于记录在 qemu-system-riscv64 上运行 UniProton 遇到的问题

旨在**帮助小队成员更好的入门UniProton ，以及更好的去发掘UniProton的各个issue**

欢迎各个小队成员提交相应的PR，小队队长会协助一同挖掘对应问题的原因以及如何解决，同时向OERV上游团队仓库申请对应的ISSUE

## 阐述问题格式模板

------

- 问题概述
  - 环境描述
    - qemu-system-riscv64 版本
    - host 主机使用的发行版
    - riscv-gcc 交叉编译器
      - riscv -gcc 版本
      - riscv -gcc 编译参数 [描述一下是否对原UniProton仓库内的编译参数有修改]
      - riscv -gcc 链接参数 [描述一下是否对原UniProton仓库内的链接参数有修改]
      - riscv -gcc 汇编参数 [描述一下是否对原UniProton仓库内的汇编参数有修改]
  - 遇到的问题描述
    - 比较自由，但是希望尽量描述清楚，可以参考其他问题阐述的内容
- 问题发生原因
  - 较自由，但是希望尽量描述清楚，可以参考其他问题阐述的内容，不同的问题对应的原因是不一致的
- 问题解决思路
  - 解决思路： 
  - 是否已解决：
  - 是否需要提交对应的PR：

------

- demo中裸机浮点数fcsr寄存器未初始化导致浮点数运算异常

  - 环境描述
    - qemu 版本  ： 7.2.0
    - host              :  x86 ubuntu 22.04 lts , 但是使用docker加载的uniproton官方环境镜像        
    - riscv-gcc 交叉编译器
      - riscv -gcc  :  保持和官方镜像内一致 - 13.2.0
      - riscv -gcc 编译参数  :  和仓库内的保持一致
      - riscv -gcc 链接参数  :  和仓库内的保持一致
      - riscv -gcc 汇编参数  :  和仓库内的保持一致

  - 遇到的问题描述
    - 在任意函数中尝试执行浮点数命令的时候，会发生异常，来到trap的地址执行trap，但是查阅qemu手册，发现7.2.0的 virt 是支持gc 扩展的，同时misa寄存器里面关于F的位也为1, 也就是说支持 f 扩展 ， 按照常理不应该触发异常。同时我尝试加载OPENSBI固件，在固件之后运行浮点数扩展的指令，发现没有发生异常，说明确实当前的qemu环境是支持F扩展的。

- 问题发生原因
  - 经过上述的查找，我猜测是CPU上电后，浮点数寄存器在初始状态下是不能直接使用的，而OPENSBI是做了全面的初始化 ，所以在OPENSBI运行后能够使用F扩展的指令集，但是我对F扩展的寄存器具体细节并不理解，经过多次查询手册，谷歌以及百度后，发现即使CPU支持F扩展，也需要在mstatus寄存器里面初始化FS位才能够使用。
- 问题解决思路
  - 解决思路：      在demo 目录中的板载入口处加入对mstatus fs 位的初始化
  - 是否已解决：  目前已解决
  - 是否需要提交对应的PR： 需要提交PR，对应适配MUSL LIBC测试案例的PR， 下次PR一起提交

------

